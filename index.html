<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>阿拉伯语单词学习卡（自动记忆防重复）</title>
  <style>
    /* ...你的样式...（省略）... */
  </style>
</head>
<body>
  <div class="container">
    <h1>阿拉伯语单词学习卡</h1>
    <div class="word-card" id="wordCard">
      <div class="welcome-message">
        <p>点击下方按钮开始学习阿拉伯语单词</p>
        <div class="example">
          <div class="word-display">بيت</div>
          <div class="translation">中文: 房子</div>
          <div class="translation">English: house</div>
        </div>
      </div>
    </div>
    <div class="controls">
      <button class="primary-btn" id="nextBtn" onclick="loadWord()">
        <span id="nextBtnText">下一张</span>
      </button>
      <button class="secondary-btn" id="speakBtn" onclick="speakWord()" disabled>
        朗读
      </button>
    </div>
    <div id="errorContainer" class="error-container hidden"></div>
    <div class="stats">
      已学习 <span id="wordCount">0</span> 个单词
    </div>
  </div>
  <script>
    // 自动记忆：用 localStorage 记录已出现单词
    function getHistory() {
      try {
        return JSON.parse(localStorage.getItem('ar_words_history') || '[]');
      } catch {
        return [];
      }
    }
    function saveHistory(arr) {
      localStorage.setItem('ar_words_history', JSON.stringify(arr));
    }
    function resetHistory() {
      localStorage.removeItem('ar_words_history');
    }

    let shownWords = getHistory();
    let currentWord = null;
    let wordCounter = shownWords.length;
    let isLoading = false;
    const wordCard = document.getElementById("wordCard");
    const nextBtn = document.getElementById("nextBtn");
    const speakBtn = document.getElementById("speakBtn");
    const errorContainer = document.getElementById("errorContainer");
    const wordCountElement = document.getElementById("wordCount");
    const nextBtnText = document.getElementById("nextBtnText");

    async function loadWord(attempt = 1) {
      if (isLoading) return;
      isLoading = true;
      nextBtn.disabled = true;
      nextBtnText.innerHTML = `<span class="loading"></span> 加载中`;
      speakBtn.disabled = true;
      hideError();
      wordCard.innerHTML = `
        <div style="text-align: center;">
          <div class="loading" style="margin: 0 auto;"></div>
          <p>正在获取单词...</p>
        </div>
      `;

      try {
        // POST请求，把本地所有已展示过的单词作为 shownWords 传给后端
        const response = await fetch("https://arabic-proxy.head-6c9.workers.dev/", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ shownWords })
        });
        if (!response.ok) throw new Error(`请求失败: ${response.status} ${response.statusText}`);
        const data = await response.json();
        if (!data.word) throw new Error("API返回格式有误");

        // 前端本地再去重
        if (shownWords.includes(data.word)) {
          if (attempt < 10) {
            // 再请求一次（防止AI重复，最多尝试10次）
            await loadWord(attempt + 1);
            return;
          } else {
            showError("抱歉，暂时没有新单词可显示！");
            isLoading = false;
            nextBtn.disabled = false;
            nextBtnText.textContent = "下一张";
            return;
          }
        }

        // 新词，保存进本地历史
        shownWords.push(data.word);
        saveHistory(shownWords);
        renderWordCard(data);
        currentWord = data.word;
        wordCounter = shownWords.length;
        wordCountElement.textContent = wordCounter;
        speakBtn.disabled = false;
      } catch (error) {
        showError(error.message);
      } finally {
        isLoading = false;
        nextBtn.disabled = false;
        nextBtnText.textContent = "下一张";
      }
    }

    function renderWordCard(wordData) {
      wordCard.innerHTML = `
        <div class="word-display">${wordData.word}</div>
        <div class="translation">中文: ${wordData.zh}</div>
        <div class="translation">English: ${wordData.en}</div>
      `;
    }
    function showError(message) {
      errorContainer.innerHTML = `
        <p>❌ ${message}</p>
        <button onclick="loadWord()" class="primary-btn" style="margin-top: 0.5rem;">重试</button>
        <button onclick="resetAll()" class="secondary-btn" style="margin-top: 0.5rem;">重置记忆</button>
      `;
      errorContainer.classList.remove("hidden");
    }
    function hideError() {
      errorContainer.classList.add("hidden");
    }
    function resetAll() {
      resetHistory();
      shownWords = [];
      wordCounter = 0;
      wordCountElement.textContent = "0";
      hideError();
      wordCard.innerHTML = `
        <div class="welcome-message">
          <p>点击下方按钮开始学习阿拉伯语单词</p>
          <div class="example">
            <div class="word-display">بيت</div>
            <div class="translation">中文: 房子</div>
            <div class="translation">English: house</div>
          </div>
        </div>
      `;
    }
    function speakWord() {
      if (!currentWord) return;
      try {
        if (!window.speechSynthesis) throw new Error("您的浏览器不支持语音合成");
        const utterance = new SpeechSynthesisUtterance(currentWord);
        utterance.lang = 'ar-SA';
        utterance.rate = 0.8;
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(utterance);
      } catch (error) {
        showError(`朗读失败: ${error.message}`);
      }
    }
    document.addEventListener('DOMContentLoaded', () => {
      if (!window.speechSynthesis) speakBtn.style.display = 'none';
      wordCountElement.textContent = wordCounter;
    });
  </script>
</body>
</html>
